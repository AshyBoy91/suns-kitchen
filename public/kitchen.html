<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen - JaiDee Resort</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#111827;--card:#1f2937;--border:#374151;--text:#f3f4f6;--dim:#9ca3af;--new:#f97316;--prep:#eab308;--ready:#22c55e;--done:#3b82f6;--served:#8b5cf6}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .top{background:var(--card);padding:14px 24px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
    .top h1{font-size:20px;color:#c9a96e}
    .top .conn{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--dim)}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--ready)}
    .dot.off{background:#ef4444}
    .stats{display:flex;gap:12px;padding:14px 24px;overflow-x:auto}
    .st{padding:6px 14px;border-radius:16px;font-size:12px;font-weight:600}
    .st-new{background:rgba(249,115,22,.15);color:var(--new)}
    .st-prep{background:rgba(234,179,8,.15);color:var(--prep)}
    .st-ready{background:rgba(34,197,94,.15);color:var(--ready)}
    .filters{display:flex;gap:6px;padding:0 24px 14px}
    .fbtn{padding:6px 14px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--dim);font-size:12px;font-weight:600;cursor:pointer}
    .fbtn.active{background:#c9a96e;color:#111;border-color:#c9a96e}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;padding:0 24px 40px}
    .ocard{background:var(--card);border:2px solid var(--border);border-radius:10px;overflow:hidden;animation:si .3s}
    @keyframes si{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    .ocard.s-new{border-color:var(--new)}
    .ocard.s-preparing{border-color:var(--prep)}
    .ocard.s-ready{border-color:var(--ready)}
    .ocard.s-done,.ocard.s-served{border-color:var(--done);opacity:.5}
    .oh{padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
    .ocard.s-new .oh{background:rgba(249,115,22,.08)}
    .ocard.s-preparing .oh{background:rgba(234,179,8,.08)}
    .ocard.s-ready .oh{background:rgba(34,197,94,.08)}
    .oid{font-size:20px;font-weight:800}
    .otbl{font-size:13px;font-weight:700;padding:3px 10px;border-radius:6px;background:rgba(255,255,255,.08)}
    .ost{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:3px 8px;border-radius:4px}
    .s-new .ost{background:var(--new);color:#fff}
    .s-preparing .ost{background:var(--prep);color:#222}
    .s-ready .ost{background:var(--ready);color:#fff}
    .s-done .ost,.s-served .ost{background:var(--done);color:#fff}
    .otime{font-size:11px;color:var(--dim)}
    .oi{padding:10px 14px}
    .oil{display:flex;justify-content:space-between;padding:5px 0;font-size:14px;border-bottom:1px solid rgba(255,255,255,.04)}
    .oil:last-child{border:none}
    .oiq{background:rgba(255,255,255,.08);padding:1px 6px;border-radius:3px;font-weight:700;font-size:12px;margin-right:6px}
    .onotes{padding:0 14px 10px;font-size:12px;color:var(--prep);font-style:italic}
    .ospicy{padding:0 14px 6px;font-size:12px;display:flex;gap:8px;flex-wrap:wrap}
    .spicy-badge{padding:3px 8px;border-radius:10px;font-weight:700;font-size:11px}
    .spicy-0{background:rgba(255,255,255,.08);color:var(--dim)}
    .spicy-1{background:rgba(249,115,22,.15);color:#fb923c}
    .spicy-2{background:rgba(249,115,22,.25);color:#f97316}
    .spicy-3{background:rgba(239,68,68,.2);color:#ef4444}
    .spicy-4{background:rgba(239,68,68,.35);color:#fca5a5;animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .allergy-badge{padding:3px 8px;border-radius:10px;background:rgba(239,68,68,.2);color:#fca5a5;font-weight:700;font-size:11px}
    .oact{padding:0 14px 12px;display:flex;gap:6px}
    .abtn{flex:1;padding:9px;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.5px}
    .abtn:active{transform:scale(.97)}
    .abtn-prep{background:var(--prep);color:#222}
    .abtn-ready{background:var(--ready);color:#fff}
    .abtn-served{background:var(--served);color:#fff}
    .abtn-done{background:var(--done);color:#fff}
    .empty{text-align:center;padding:60px;color:var(--dim)}
    .empty .icon{font-size:48px;margin-bottom:12px}
  </style>
</head>
<body>
<div class="top">
  <div><h1>JaiDee Kitchen</h1><div class="conn"><div class="dot" id="dot"></div><span id="connTxt">Connected</span></div></div>
  <div class="stats">
    <span class="st st-new" id="sNew">0 New</span>
    <span class="st st-prep" id="sPrep">0 Preparing</span>
    <span class="st st-ready" id="sReady">0 Ready</span>
  </div>
</div>
<div class="filters" id="filters">
  <button class="fbtn active" onclick="sf('active')">Active</button>
  <button class="fbtn" onclick="sf('all')">All</button>
  <button class="fbtn" onclick="sf('new')">New</button>
  <button class="fbtn" onclick="sf('preparing')">Preparing</button>
  <button class="fbtn" onclick="sf('ready')">Ready</button>
</div>
<div class="grid" id="grid"></div>

<script>
let orders=[],filter="active";
const es=new EventSource("/api/kitchen/stream");
es.onmessage=e=>{const d=JSON.parse(e.data);if(d.type==="init"){orders=d.orders;render()}else if(d.type==="new_order"){orders.unshift(d.order);render();beep()}else if(d.type==="order_updated"){const i=orders.findIndex(o=>o.id===d.order.id);if(i!==-1)orders[i]=d.order;render()}};
es.onopen=()=>{document.getElementById("dot").classList.remove("off");document.getElementById("connTxt").textContent="Connected"};
es.onerror=()=>{document.getElementById("dot").classList.add("off");document.getElementById("connTxt").textContent="Reconnecting..."};

function sf(f){filter=f;document.querySelectorAll(".fbtn").forEach(b=>b.classList.toggle("active",b.textContent.toLowerCase()===f||(f==="active"&&b.textContent==="Active")));render()}
function getF(){if(filter==="active")return orders.filter(o=>!["done","served"].includes(o.status));if(filter==="all")return orders;return orders.filter(o=>o.status===filter)}
function ago(d){const s=Math.floor((Date.now()-new Date(d))/1e3);if(s<60)return s+"s";if(s<3600)return Math.floor(s/60)+"m";return Math.floor(s/3600)+"h"}

function render(){
  const f=getF();
  const c={new:0,preparing:0,ready:0};orders.forEach(o=>{if(c[o.status]!==undefined)c[o.status]++});
  document.getElementById("sNew").textContent=c.new+" New";
  document.getElementById("sPrep").textContent=c.preparing+" Prep";
  document.getElementById("sReady").textContent=c.ready+" Ready";
  if(!f.length){document.getElementById("grid").innerHTML=`<div class="empty"><div class="icon">&#127860;</div><h3>No orders</h3></div>`;return}
  document.getElementById("grid").innerHTML=f.map(o=>`
    <div class="ocard s-${o.status}"><div class="oh"><div><span class="oid">#${o.id}</span> <span class="otime">${ago(o.createdAt)} ago</span></div><div style="display:flex;gap:6px;align-items:center"><span class="otbl">T${o.tableNumber}</span><span class="ost">${o.status}</span></div></div>
    <div class="oi">${o.items.map(i=>`<div class="oil"><span><span class="oiq">${i.quantity}x</span>${i.name}</span><span>à¸¿${i.price*i.quantity}</span></div>`).join("")}</div>
    <div class="ospicy">
      ${o.spicyLevel>0?`<span class="spicy-badge spicy-${o.spicyLevel}">${'&#127798;'.repeat(Math.min(o.spicyLevel,3))}${o.spicyLevel>=4?'&#128293;':''} ${['','Mild','Medium','Hot','THAI HOT'][o.spicyLevel]}</span>`:''}
      ${(o.allergies||[]).map(a=>`<span class="allergy-badge">&#9888; ${a}</span>`).join('')}
    </div>
    ${o.notes?`<div class="onotes">Note: ${o.notes}</div>`:''}
    <div class="oact">
      ${o.status==="new"?`<button class="abtn abtn-prep" onclick="us(${o.id},'preparing')">Preparing</button>`:''}
      ${o.status==="preparing"?`<button class="abtn abtn-ready" onclick="us(${o.id},'ready')">Ready</button>`:''}
      ${o.status==="ready"?`<button class="abtn abtn-served" onclick="us(${o.id},'served')">Served</button>`:''}
    </div></div>
  `).join("")}

async function us(id,s){await fetch(`/api/orders/${id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:s})})}
function beep(){try{const c=new(window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator();const g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=800;g.gain.value=.25;o.start();g.gain.exponentialRampToValueAtTime(.01,c.currentTime+.4);o.stop(c.currentTime+.4);setTimeout(()=>{const o2=c.createOscillator();const g2=c.createGain();o2.connect(g2);g2.connect(c.destination);o2.frequency.value=1e3;g2.gain.value=.25;o2.start();g2.gain.exponentialRampToValueAtTime(.01,c.currentTime+.4);o2.stop(c.currentTime+.4)},200)}catch(e){}}
setInterval(render,30000);
</script>
</body>
</html>
