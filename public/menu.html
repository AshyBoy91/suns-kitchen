<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sun's Kitchen - Menu</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #e65100;
      --primary-light: #ff833a;
      --primary-dark: #ac1900;
      --bg: #fafafa;
      --card: #ffffff;
      --text: #212121;
      --text-light: #757575;
      --success: #2e7d32;
      --border: #e0e0e0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      max-width: 480px;
      margin: 0 auto;
      padding-bottom: 100px;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 24px 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header p { font-size: 13px; opacity: 0.9; margin-top: 4px; }

    /* Table selector */
    .table-bar {
      background: white;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 76px;
      z-index: 99;
    }
    .table-bar label { font-size: 14px; font-weight: 600; white-space: nowrap; }
    .table-bar select {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      background: white;
      appearance: auto;
    }

    /* Category tabs */
    .categories {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      overflow-x: auto;
      background: white;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 120px;
      z-index: 98;
    }
    .categories::-webkit-scrollbar { display: none; }
    .cat-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      background: #f5f5f5;
      color: var(--text-light);
      transition: all 0.2s;
    }
    .cat-btn.active {
      background: var(--primary);
      color: white;
    }

    /* Menu items */
    .menu-section { padding: 12px 16px; }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      padding: 12px 4px 8px;
      color: var(--text);
    }
    .menu-item {
      background: var(--card);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
    }
    .item-emoji {
      font-size: 36px;
      width: 54px;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff3e0;
      border-radius: 12px;
      flex-shrink: 0;
    }
    .item-info { flex: 1; min-width: 0; }
    .item-name { font-size: 15px; font-weight: 600; }
    .item-desc { font-size: 12px; color: var(--text-light); margin-top: 2px; }
    .item-price { font-size: 15px; font-weight: 700; color: var(--primary); margin-top: 4px; }
    .item-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .qty-btn {
      width: 30px; height: 30px;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .qty-btn.minus { background: #ffebee; color: #c62828; }
    .qty-btn.plus { background: var(--primary); color: white; }
    .qty-btn:active { transform: scale(0.9); }
    .qty-display {
      font-size: 16px;
      font-weight: 700;
      min-width: 20px;
      text-align: center;
    }

    /* Cart bar */
    .cart-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      background: var(--primary);
      color: white;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      z-index: 200;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.15);
      transition: transform 0.3s;
    }
    .cart-bar.hidden { transform: translateX(-50%) translateY(100%); }
    .cart-info { font-size: 14px; font-weight: 600; }
    .cart-total { font-size: 18px; font-weight: 700; }
    .cart-action {
      background: white;
      color: var(--primary);
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 300;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .modal {
      background: white;
      width: 100%;
      max-width: 480px;
      border-radius: 20px 20px 0 0;
      padding: 24px 20px 32px;
      transform: translateY(100%);
      transition: transform 0.3s;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal h2 { font-size: 20px; margin-bottom: 16px; }
    .modal-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }
    .modal-item span:last-child { font-weight: 600; }
    .modal-total {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      font-size: 18px;
      font-weight: 700;
      border-top: 2px solid var(--text);
      margin-top: 8px;
    }
    .notes-input {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      margin: 12px 0;
      resize: none;
      font-family: inherit;
    }
    .place-order-btn {
      width: 100%;
      padding: 16px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
    }
    .place-order-btn:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
    }
    .close-modal {
      position: absolute;
      top: 16px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-light);
    }

    /* Success screen */
    .success-screen {
      position: fixed;
      inset: 0;
      background: white;
      z-index: 400;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .success-screen.active { opacity: 1; pointer-events: all; }
    .success-icon { font-size: 80px; margin-bottom: 20px; }
    .success-screen h2 { font-size: 24px; margin-bottom: 8px; color: var(--success); }
    .success-screen p { font-size: 16px; color: var(--text-light); margin-bottom: 24px; }
    .success-screen .order-num { font-size: 48px; font-weight: 800; color: var(--primary); }
    .new-order-btn {
      margin-top: 32px;
      padding: 14px 40px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>Sun's Kitchen</h1>
    <p>Fresh flavors, made with love</p>
  </div>

  <div class="table-bar">
    <label>Table:</label>
    <select id="tableSelect">
      <option value="">Select your table</option>
    </select>
  </div>

  <div class="categories" id="categoryTabs"></div>
  <div class="menu-section" id="menuList"></div>

  <!-- Cart bottom bar -->
  <div class="cart-bar hidden" id="cartBar" onclick="openCart()">
    <div>
      <div class="cart-info" id="cartInfo">0 items</div>
      <div class="cart-total" id="cartTotal">$0</div>
    </div>
    <button class="cart-action">View Order</button>
  </div>

  <!-- Cart modal -->
  <div class="modal-overlay" id="cartModal">
    <div class="modal" style="position:relative;">
      <button class="close-modal" onclick="closeCart()">&times;</button>
      <h2>Your Order</h2>
      <div id="cartItems"></div>
      <div class="modal-total">
        <span>Total</span>
        <span id="modalTotal">$0</span>
      </div>
      <textarea class="notes-input" id="orderNotes" rows="2" placeholder="Special instructions (allergies, spice level, etc.)"></textarea>
      <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">Place Order</button>
    </div>
  </div>

  <!-- Success screen -->
  <div class="success-screen" id="successScreen">
    <div class="success-icon">&#10003;</div>
    <h2>Order Placed!</h2>
    <p>Your order number is</p>
    <div class="order-num" id="orderNumber">#1</div>
    <p style="margin-top:16px;">We're preparing your food. Sit tight!</p>
    <button class="new-order-btn" onclick="resetOrder()">Order More</button>
  </div>

<script>
  let menu = [];
  let cart = {};
  let activeCategory = "All";

  // Generate table options
  const tableSelect = document.getElementById("tableSelect");
  for (let i = 1; i <= 20; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Table ${i}`;
    tableSelect.appendChild(opt);
  }

  // Check URL for table param
  const urlParams = new URLSearchParams(window.location.search);
  const tableParam = urlParams.get("table");
  if (tableParam) tableSelect.value = tableParam;

  // Fetch menu
  fetch("/api/menu")
    .then(r => r.json())
    .then(data => {
      menu = data;
      renderCategories();
      renderMenu();
    });

  function renderCategories() {
    const cats = ["All", ...new Set(menu.map(i => i.category))];
    const container = document.getElementById("categoryTabs");
    container.innerHTML = cats.map(c =>
      `<button class="cat-btn ${c === activeCategory ? 'active' : ''}" onclick="filterCategory('${c}')">${c}</button>`
    ).join("");
  }

  function filterCategory(cat) {
    activeCategory = cat;
    renderCategories();
    renderMenu();
  }

  function renderMenu() {
    const filtered = activeCategory === "All" ? menu : menu.filter(i => i.category === activeCategory);
    const grouped = {};
    filtered.forEach(item => {
      if (!grouped[item.category]) grouped[item.category] = [];
      grouped[item.category].push(item);
    });

    const container = document.getElementById("menuList");
    let html = "";
    for (const [cat, items] of Object.entries(grouped)) {
      html += `<div class="section-title">${cat}</div>`;
      items.forEach(item => {
        const qty = cart[item.id] || 0;
        html += `
          <div class="menu-item">
            <div class="item-emoji">${item.image}</div>
            <div class="item-info">
              <div class="item-name">${item.name}</div>
              <div class="item-desc">${item.description}</div>
              <div class="item-price">$${item.price}</div>
            </div>
            <div class="item-actions">
              ${qty > 0 ? `
                <button class="qty-btn minus" onclick="changeQty(${item.id}, -1)">-</button>
                <span class="qty-display">${qty}</span>
              ` : ''}
              <button class="qty-btn plus" onclick="changeQty(${item.id}, 1)">+</button>
            </div>
          </div>`;
      });
    }
    container.innerHTML = html;
  }

  function changeQty(id, delta) {
    cart[id] = Math.max(0, (cart[id] || 0) + delta);
    if (cart[id] === 0) delete cart[id];
    renderMenu();
    updateCartBar();
  }

  function updateCartBar() {
    const ids = Object.keys(cart);
    const totalItems = Object.values(cart).reduce((s, q) => s + q, 0);
    const totalPrice = ids.reduce((s, id) => {
      const item = menu.find(i => i.id === parseInt(id));
      return s + item.price * cart[id];
    }, 0);

    const bar = document.getElementById("cartBar");
    if (totalItems === 0) {
      bar.classList.add("hidden");
    } else {
      bar.classList.remove("hidden");
      document.getElementById("cartInfo").textContent = `${totalItems} item${totalItems > 1 ? 's' : ''}`;
      document.getElementById("cartTotal").textContent = `$${totalPrice}`;
    }
  }

  function openCart() {
    const container = document.getElementById("cartItems");
    let html = "";
    let total = 0;
    for (const [id, qty] of Object.entries(cart)) {
      const item = menu.find(i => i.id === parseInt(id));
      const subtotal = item.price * qty;
      total += subtotal;
      html += `<div class="modal-item"><span>${item.name} x${qty}</span><span>$${subtotal}</span></div>`;
    }
    container.innerHTML = html;
    document.getElementById("modalTotal").textContent = `$${total}`;
    document.getElementById("cartModal").classList.add("active");
  }

  function closeCart() {
    document.getElementById("cartModal").classList.remove("active");
  }

  async function placeOrder() {
    const table = tableSelect.value;
    if (!table) {
      alert("Please select your table number!");
      closeCart();
      return;
    }

    const btn = document.getElementById("placeOrderBtn");
    btn.disabled = true;
    btn.textContent = "Placing order...";

    const items = Object.entries(cart).map(([id, qty]) => {
      const item = menu.find(i => i.id === parseInt(id));
      return { id: item.id, name: item.name, price: item.price, quantity: qty };
    });

    try {
      const res = await fetch("/api/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          tableNumber: parseInt(table),
          items,
          notes: document.getElementById("orderNotes").value
        })
      });
      const data = await res.json();
      closeCart();
      document.getElementById("orderNumber").textContent = `#${data.orderId}`;
      document.getElementById("successScreen").classList.add("active");
    } catch (err) {
      alert("Failed to place order. Please try again.");
    }

    btn.disabled = false;
    btn.textContent = "Place Order";
  }

  function resetOrder() {
    cart = {};
    document.getElementById("orderNotes").value = "";
    document.getElementById("successScreen").classList.remove("active");
    renderMenu();
    updateCartBar();
  }

  // Close modal on overlay click
  document.getElementById("cartModal").addEventListener("click", function(e) {
    if (e.target === this) closeCart();
  });
</script>
</body>
</html>
